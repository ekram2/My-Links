<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ğŸ“ Fancy Link Manager + Google Sign-In</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      background: #121212;
      color: #eee;
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      padding: 1rem;
    }
    h1 {
      text-align: center;
      color: #f5c518;
    }
    .section {
      margin: 1rem 0;
      border-left: 4px solid #444;
      padding-left: 1rem;
    }
    .section-title {
      font-weight: bold;
      font-size: 1.2rem;
      cursor: text;
      margin-bottom: 0.5rem;
      outline: none;
    }
    .link-item {
      background: #2b2b2b;
      padding: 0.5rem;
      margin: 0.5rem 0;
      display: flex;
      align-items: center;
      border-radius: 8px;
      cursor: grab;
      gap: 0.5rem;
    }
    .link-item img {
      width: 16px;
      height: 16px;
    }
    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-top: 1rem;
    }
    button {
      background: #f5c518;
      color: #000;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 5px;
      cursor: pointer;
    }
    input[type="url"] {
      padding: 0.4rem;
      width: 240px;
      border-radius: 4px;
      border: none;
    }
    #userInfo {
      text-align: center;
      margin-top: 1rem;
      font-size: 0.9rem;
      color: #ccc;
    }
  </style>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>

  <h1>ğŸ“ Fancy Link Manager</h1>
  <div id="userInfo">ğŸ”’ Not signed in</div>
  <div id="container"></div>

  <div class="controls">
    <input id="newLink" placeholder="https://example.com" type="url">
    <button onclick="addLink()">â• Add Link</button>
    <button onclick="addHeading()">ğŸ“ Add Heading</button>
    <button onclick="saveToDrive()">ğŸ’¾ Save</button>
    <button onclick="loadFromDrive()">ğŸ” Load</button>
  </div>

  <div id="g_id_onload"
       data-client_id="844655246605-5jgg0vg58m3fp57ej8ucf2po571h12b4.apps.googleusercontent.com"
       data-context="signin"
       data-callback="handleSignIn"
       data-auto_prompt="false">
  </div>

  <div class="g_id_signin"
       data-type="standard"
       data-shape="pill"
       data-theme="outline"
       data-text="sign_in_with"
       data-size="large">
  </div>

  <script>
    const container = document.getElementById('container');
    const userInfo = document.getElementById('userInfo');
    const SCRIPT_URL = "https://script.google.com/macros/library/d/1twqpEsMwcjrmJRiPjqEwlpM9J9lDRa2ToV5yD_MGC022WzOPkGaQHuLu/1"; // << Replace this

    let userEmail = "";

    function createFavicon(url) {
      try {
        const domain = new URL(url).hostname;
        return `https://www.google.com/s2/favicons?sz=32&domain=${domain}`;
      } catch {
        return '';
      }
    }

    function createLinkItem(url) {
      const item = document.createElement('div');
      item.className = 'link-item';
      item.draggable = true;
      item.innerHTML = `
        <img src="${createFavicon(url)}">
        <a href="${url}" target="_blank" style="color:white;">${url}</a>
        <button onclick="this.parentElement.remove()">âŒ</button>
      `;
      addDragEvents(item);
      return item;
    }

    function createHeading(title = "Untitled Section") {
      const section = document.createElement('div');
      section.className = 'section';

      const editableTitle = document.createElement('div');
      editableTitle.className = 'section-title';
      editableTitle.contentEditable = true;
      editableTitle.innerText = title;

      section.appendChild(editableTitle);
      container.appendChild(section);
    }

    function addLink() {
      const url = document.getElementById('newLink').value;
      if (!url) return;
      const lastSection = container.lastElementChild || createHeading('Links');
      if (!lastSection.classList.contains('section')) createHeading('Links');
      lastSection.appendChild(createLinkItem(url));
      document.getElementById('newLink').value = '';
    }

    function addHeading() {
      createHeading();
    }

    function exportJSON() {
      const data = [];
      container.querySelectorAll('.section').forEach(section => {
        const title = section.querySelector('.section-title').innerText;
        const links = [...section.querySelectorAll('.link-item a')].map(a => a.href);
        data.push({ title, links });
      });
      return JSON.stringify(data);
    }

    function importJSON(json) {
      container.innerHTML = '';
      JSON.parse(json).forEach(sectionData => {
        createHeading(sectionData.title);
        const section = container.lastElementChild;
        sectionData.links.forEach(link => section.appendChild(createLinkItem(link)));
      });
    }

    function addDragEvents(item) {
      item.addEventListener('dragstart', e => {
        e.dataTransfer.setData('text/plain', null);
        item.classList.add('dragging');
      });
      item.addEventListener('dragend', () => item.classList.remove('dragging'));
    }

    container.addEventListener('dragover', e => {
      e.preventDefault();
      const dragging = document.querySelector('.dragging');
      const after = [...container.querySelectorAll('.link-item')].find(el => e.clientY < el.getBoundingClientRect().top + el.offsetHeight / 2);
      const parent = dragging?.closest('.section');
      if (parent) parent.insertBefore(dragging, after);
    });

    // Google Drive Sync
    async function saveToDrive() {
      if (!userEmail) return alert("Please sign in first.");
      const response = await fetch(SCRIPT_URL, {
        method: 'POST',
        body: JSON.stringify({ mode: 'save', data: exportJSON(), email: userEmail }),
        headers: { 'Content-Type': 'application/json' }
      });
      alert("âœ… Saved to Drive");
    }

    async function loadFromDrive() {
      if (!userEmail) return alert("Please sign in first.");
      const response = await fetch(`${SCRIPT_URL}?mode=load&email=${encodeURIComponent(userEmail)}`);
      const text = await response.text();
      if (text) importJSON(text);
      else alert("âš ï¸ No data found.");
    }

    // Google Sign-In
    function handleSignIn(response) {
      const decoded = parseJwt(response.credential);
      userEmail = decoded.email;
      userInfo.innerHTML = `ğŸ‘¤ Signed in as <b>${decoded.name}</b> (${userEmail})`;
    }

    function parseJwt(token) {
      const base64Url = token.split('.')[1];
      const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
      return JSON.parse(decodeURIComponent(atob(base64).split('').map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join('')));
    }
  </script>

</body>
</html>
